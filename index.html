<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>Speaker badge for ContosoConf</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css"
        integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous">
    <link href="styles/main.css" rel="stylesheet" type="text/css" />
    <link href="styles/print.css" media="print" rel="stylesheet" type="text/css" />
</head>

<body>

    <nav class="page-nav">
        <div class="container">
            <a href="#"><i class="far fa-id-badge"></i>&nbsp;&nbsp; Створення беджа працівника або студента коледжу</a>
        </div>
    </nav>

    <section class="page-section badge">
        <div class="container">
            <h1>Створіть свій бедж самостійно</h1>
            <canvas id="mybadge" width="600" height="250" style="border: 1px solid #888" data-speaker-id="0662229627"
                data-speaker-name="Василь" data-speaker-surname="Пупкін" data-speaker-title="викладач">
            </canvas>
            <br>

            <section id="form">

                <br>
                <label>
                    Ваше ім'я:
                    <input type="text" id="name" />
                </label>
                <label>
                    Прізвище:
                    <input type="text" id="surname" />
                </label><br><br>
                <label>
                    Посада:&nbsp;&nbsp;&nbsp;&nbsp;
                    <select id="title">
                        <option value="викладач">викладач</option>
                        <option value="студент">студент</option>
                        <option value="працівник коледжу">працівник коледжу</option>
                        <option value="заступник директора">заступник директора</option>
                        <option value="директор">директор</option>
                    </select>
                </label>
                <label>
                    &nbsp;Телефон:&nbsp;&nbsp;
                    <input id="phone" type="tel" pattern="[\0]\d{2}\d{7}" />
                </label>
                <br><br>
                <video onclick="snapshot(this);" width=185 height=185 id="video" controls autoplay
                    style="margin-left: 8rem;"></video>
                <div style="float: right; margin-right: 39.7rem; margin-top: 4.2rem;">
                    <button id="start" style="width: 190px;margin-bottom: 10px;"><i class="fas fa-play"
                            style="color:grey;"></i>&nbsp;Увімкнути
                        камеру</button><br>
                    <button id="stop" style="width: 190px;margin-bottom: 10px;"><i class="fas fa-pause"
                            style="color: red;"></i>&nbsp;&nbsp;Вимкнути
                        камеру</button><br>
                    <button id="snap" style="width: 190px;margin-bottom: 10px;"><i class="fas fa-user"
                            style="color:green;"></i>&nbsp;&nbsp;&nbsp;&nbsp;Зробити знімок</button>
                </div>
                <div style="float: right; margin-right: 39.7rem; margin-top: -19.1rem;">
                    <button id="create"
                        style="width: 190px;margin-bottom: 10px;border: 3px solid green;background-color: lightgreen;"><i
                            class="fas fa-check"></i>&nbsp;&nbsp;Сформувати
                        бедж</button><br>
                </div>
                <div style="float: right; margin-right: 39.7rem; margin-top: -3.1rem;">
                    <button id="print" onclick="window.print();"
                        style="width: 190px;margin-bottom: 10px;border: 3px solid green;">
                        <i class="fas fa-print"></i>&nbsp;&nbsp;Друкувати бедж</button><br>
                </div>

            </section>

            <div style="display:none;">
                <img id="logo" src="img/logo.png" width="300" height="227">
            </div>
        </div>
    </section>

    <footer class="page-footer">
        <div class="container">
            <p>
                Полтавський політехнічний коледж Національного технічного університету "Харківський політехнічний
                інститут"
            </p>
            <address>
                <br />
                вулиця Пушкіна, 83а<br />
                Полтава, Полтавська область<br />
                UA-36000
            </address>
            <p>
                &#169; 2019 ППК НТУ "ХПІ"
            </p>
        </div>
    </footer>


    <script>
        class speakerBadgePage {

            constructor(element) {
                this.canvas = element.querySelector("canvas");

                this.speakerId = this.canvas.getAttribute("data-speaker-id");
                this.speakerName = this.canvas.getAttribute("data-speaker-name");
                this.speakerSurName = this.canvas.getAttribute("data-speaker-surname");
                this.speakerTitle = this.canvas.getAttribute("data-speaker-title");
                this.canvas.addEventListener("dragover", this.handleDragOver.bind(this));
                this.canvas.addEventListener("drop", this.handleDrop.bind(this));

                this.drawBadge();
            }

            handleDragOver(event) {
                event.stopPropagation();
                event.preventDefault();
                event.dataTransfer.dropEffect = 'copy'; // Makes the browser display a "copy" cursor.
            }

            handleDrop(event) {
                event.stopPropagation();
                event.preventDefault();

                const files = event.dataTransfer.files;
                if (files.length == 0) return;

                // More than one file could have been dropped, we'll just use the first.
                const file = files[0];
                if (this.isImageType(file.type)) {
                    this.readFile(file)
                        .then((file) => this.loadImage(file))
                        .then((file) => this.drawBadge(file));
                } else {
                    alert("Please drop an image file.");
                }
            }

            drawBadge(image) {
                // TODO: Get the canvas's (this.canvas) context and assign to this.context
                this.context = this.canvas.getContext("2d");

                // TODO: Draw the following by calling the helper methods of `this`
                //       background
                //       top text
                //       speaker name
                //       image (or placeholder if no image)
                //       bar code (passing this.speakerId)
                this.drawBackground();
                this.drawTopText();
                this.drawSpeakerName();
                if (image) {
                    this.drawSpeakerImage(image);
                } else {
                    this.drawImagePlaceholder();
                }
                this.drawBarCode(this.speakerId);
                this.drawLogo();
                this.drawSpeakerTitle();
            }

            drawLogo() {
                var image = document.getElementById('logo');
                this.context.drawImage(image, 466, 56, 120, 120);
            }

            drawBackground() {
                // TODO: Fill the canvas with a white rectangle
                this.context.fillStyle = "white";
                this.context.fillRect(0, 0, this.canvas.width, this.canvas.height);
            }

            drawSpeakerImage(image) {
                // TODO: Draw the image on the canvas
                //       Draw only the center square of the image
                //       Draw at:
                //       x, y = 20, 20
                //       w, h = 160, 160
                const size = Math.min(image.width, image.height);
                const sourceX = image.width / 2 - size / 2;
                const sourceY = image.height / 2 - size / 2;
                this.context.drawImage(image, sourceX, sourceY, size, size, 20, 70, 160, 160);
            }

            drawImagePlaceholder() {
                this.context.strokeStyle = "2px #888";
                this.context.strokeRect(20, 70, 160, 160);
                this.context.font = "12px sans-serif";
                this.context.textBaseline = "middle";
                this.context.textAlign = "center";
                this.context.fillStyle = "black";
                this.context.fillText("Кидайте ваше фото сюди", 100, 150);
            }

            drawTopText() {
                this.context.font = "34.6px sans-serif";
                this.context.fillStyle = "black";
                this.context.textBaseline = "top";
                this.context.textAlign = "left";
                this.context.fillText('Полтавський політехнічний коледж', 20, 20);
            }

            drawSpeakerName() {
                // TODO: Draw this.speakerName on the canvas
                //       x, y = 200, 60
                //       font = 40px sans-serif
                //       fill style = black
                //       text baseline = top
                //       text align = left
                this.context.font = "40px sans-serif";
                this.context.fileStyle = "black";
                this.context.baseLine = "top";
                this.context.textAlign = "left";
                this.context.fillText(this.speakerName, 200, 70);
                this.context.fillText(this.speakerSurName, 200, 110);
            }

            drawSpeakerTitle() {
                // TODO: Draw this.speakerName on the canvas
                //       x, y = 200, 60
                //       font = 40px sans-serif
                //       fill style = black
                //       text baseline = top
                //       text align = left
                this.context.font = "28px sans-serif";
                this.context.fileStyle = "black";
                this.context.baseLine = "top";
                this.context.textAlign = "left";
                this.context.fillText(this.speakerTitle, 200, 160);
            }

            drawBarCode(text) {
                text = "*" + text + "*"; // Wrap in "*" deliminators.
                const encodings = {
                    "0": "bwbWBwBwb",
                    "1": "BwbWbwbwB",
                    "2": "bwBWbwbwB",
                    "3": "BwBWbwbwb",
                    "4": "bwbWBwbwB",
                    "5": "BwbWBwbwb",
                    "6": "bwBWBwbwb",
                    "7": "bwbWbwBwB",
                    "8": "BwbWbwBwb",
                    "9": "bwBWbwBwb",
                    "*": "bWbwBwBwb"
                };
                let x = 200, y = 190, height = 40, thick = 6, thin = 2;
                for (let charIndex = 0; charIndex < text.length; charIndex++) {
                    const code = encodings[text[charIndex]];
                    for (let stripeIndex = 0; stripeIndex < code.length; stripeIndex++) {
                        if (stripeIndex % 2 === 0) {
                            this.context.fillStyle = "black";
                        } else {
                            this.context.fillStyle = "white";
                        }
                        const isWideStripe = code.charCodeAt(stripeIndex) < 91;
                        if (isWideStripe) {
                            this.context.fillRect(x, y, thick, height);
                            x += thick;
                        } else {
                            this.context.fillRect(x, y, thin, height);
                            x += thin;
                        }
                    }

                    if (charIndex < text.length - 1) {
                        // Space between each
                        this.context.fillStyle = "white";
                        this.context.fillRect(x, y, thin, height);
                        x += thin;
                    }
                }
            }

            isImageType(type) {
                const imageTypes = ["image/jpeg", "image/jpg", "image/png"];
                return imageTypes.indexOf(type) === 0;
            }

            readFile(file) {
                // Return a new promise.
                return new Promise(function (resolve, reject) {

                    const reader = new FileReader();

                    reader.onload = function (loadEvent) {
                        const fileDataUrl = loadEvent.target.result;

                        resolve([fileDataUrl]);
                    };

                    reader.readAsDataURL(file);
                });
            }



            loadImage(imageUrl) {

                // Return a new promise.
                return new Promise(function (resolve, reject) {
                    const image = new Image();

                    image.onload = function () {
                        resolve(image);
                    };

                    image.src = imageUrl; // This starts the image loading
                });

            }
        }

        const badgeElement = document.querySelector(".badge");
        new speakerBadgePage(badgeElement);

    </script>

    <script>
        //
        const video = document.getElementById('video');
        const canvas = document.getElementById('mybadge');
        const snap = document.getElementById("snap");
        const start = document.getElementById("start");
        const stop = document.getElementById("stop");


        const constraints = {
            audio: false,
            video: {
                width: 720, height: 720
            }
        };

        // Access webcam
        async function init() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                handleSuccess(stream);
            } catch (e) {
                alert('Помилка увімкнення камери: ' + e.toString());
            }
        }

        // Success
        function handleSuccess(stream) {
            window.stream = stream;
            video.srcObject = stream;
        }

        start.addEventListener("click", function () {
            init();
        });


        stop.addEventListener("click", function () {
            var track = window.stream.getTracks()[0];
            track.stop();
        });


        // Draw image
        var context = canvas.getContext('2d');
        snap.addEventListener("click", function () {
            context.drawImage(video, 20, 70, 160, 160);
        });

    </script>

    <script>

        function makeBadge() {

            const create = document.getElementById("create");

            var name = $('#name').val();
            var surname = $('#surname').val();
            var title = $('#title').val();
            var phone = $('#phone').val();

            if (name.length != 0 && surname.length != 0 && title.length != 0 && phone.length != 0) {

                $('#mybadge').attr('data-speaker-id', phone);
                $('#mybadge').attr('data-speaker-name', name);
                $('#mybadge').attr('data-speaker-surname', surname);
                $('#mybadge').attr('data-speaker-title', title);

                new speakerBadgePage(badgeElement);
            }

        }
        create.addEventListener("click", function () {
            makeBadge();
        });
    </script>
</body>

</html>
